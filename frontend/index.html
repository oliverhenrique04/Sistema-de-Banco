<!doctype html>
<html lang="pt-br" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>POMENR • Microcrédito & Pagamentos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/cosmo/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --brand-primary:#0b3d91;
      --brand-accent:#00bfa6;
    }
    .navbar { background: var(--brand-primary) !important; }
    .btn-primary, .bg-primary { background-color: var(--brand-primary) !important; border-color: var(--brand-primary) !important; }
    .btn-outline-primary { border-color: var(--brand-primary) !important; color: var(--brand-primary) !important; }
    .btn-outline-primary:hover { background: var(--brand-primary) !important; color:#fff !important; }
    .link-primary { color: var(--brand-primary) !important; }

    .hidden { display:none !important; }
    .card { border-radius: 1rem; }
    .form-control, .btn { border-radius: .75rem; }
    .hero { background: linear-gradient(135deg, rgba(11,61,145,.08), rgba(0,191,166,.10)); border-radius: 1rem; padding: 1rem 1.25rem; margin: 1rem 0;}
    .nav-link.active { font-weight: 600; }
  </style>
</head>
<body>
<div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
  <div id="toastContainer"></div>
</div>

<div class="modal fade" id="customConfirmModal" tabindex="-1" aria-labelledby="customConfirmLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customConfirmLabel">Confirmação</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="customConfirmBody">
        Você tem certeza?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="customConfirmOkBtn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#/"><i class="bi bi-bank2 me-2"></i>POMENR</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navContent">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0" id="menu">
        <li class="nav-item"><a class="nav-link" data-route="#/dashboard" href="#/dashboard">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-route="#/pagamentos" href="#/pagamentos">Pagamentos</a></li>
        <li class="nav-item"><a class="nav-link" data-route="#/emprestimos" href="#/emprestimos">Empréstimos</a></li>
        </ul>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-light btn-sm" href="/api/docs" target="_blank"><i class="bi bi-journal-code me-1"></i>API</a>
        <button class="btn btn-outline-light btn-sm" id="themeBtn" title="Tema"><i class="bi bi-moon"></i></button>
        <button class="btn btn-light btn-sm" id="btnLogout"><i class="bi bi-box-arrow-right me-1"></i>Sair</button>
      </div>
    </div>
  </div>
</nav>

<main class="container my-3" id="app"></main>

<script type="text/template" id="tpl-login">
  <div class="hero"><h5 class="mb-0">Bem-vindo ao POMENR</h5><small class="text-muted">Entre para acessar seus produtos</small></div>
  <div class="row justify-content-center">
    <div class="col-12 col-md-6 col-lg-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="mb-3"><i class="bi bi-person-lock me-2"></i>Entrar</h4>
          <div class="mb-3"><label class="form-label">CPF/CNPJ</label><input class="form-control" id="login_cpf" placeholder="Somente números"></div>
          <div class="mb-3"><label class="form-label">Senha</label><input type="password" class="form-control" id="login_senha"></div>
          <button class="btn btn-primary w-100" id="doLogin">Entrar</button>
          <hr><p class="text-center small mb-0">Não tem conta? <a href="#/registrar">Registre-se</a></p>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/template" id="tpl-register">
  <div class="hero"><h5 class="mb-0">Abra sua conta POMENR</h5><small class="text-muted">Cadastre-se em poucos passos</small></div>
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h4 class="mb-3"><i class="bi bi-person-plus me-2"></i>Criar conta</h4>
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Nome</label><input id="r_nome" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">CPF/CNPJ</label><input id="r_cpf" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Email</label><input id="r_email" class="form-control"></div>
            <div class="col-md-6"><label class="form-label">Telefone</label><input id="r_tel" class="form-control"></div>
            <div class="col-md-6">
              <label class="form-label">Tipo de Usuário</label>
              <select id="r_tipo" class="form-select">
                <option value="PF">Pessoa Física (PF)</option>
                <option value="PJ">Pessoa Jurídica (PJ)</option>
              </select>
            </div>
            <div class="col-md-6"><label class="form-label">Senha</label><input type="password" id="r_senha" class="form-control" minlength="8"></div>
            <div class="col-md-6"><label class="form-label">Salário/Renda Mensal (R$)</label><input id="r_sal" class="form-control" value="3000.00" type="number" step="0.01"></div>
          </div>
          <button class="btn btn-primary mt-3" id="doRegister">Registrar</button>
          <a href="#/login" class="btn btn-link">Já tenho conta</a>
        </div>
      </div>
    </div>
  </div>
</script>

<script type="text/template" id="tpl-dashboard">
  <div class="hero">
    <h5 class="mb-1">Gastos do mês</h5>
    <small class="text-muted">Gerencie sua planilha de despesas e visualize por categoria</small>
  </div>
  
  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card shadow-sm mb-3">
        <div class="card-body">
          <h5 class="mb-3"><i class="bi bi-lightning-charge me-2"></i>Pagar Itens da Planilha</h5>
          <div id="db_bill_pay_content">
            <p class="text-muted small">Carregando itens pendentes na planilha...</p>
          </div>
          <div class="mt-3" id="db_bill_msg"></div>
        </div>
      </div>

      <div class="card shadow-sm"><div class="card-body">
        <h5 class="mb-3"><i class="bi bi-table me-2"></i>Planilha de gastos</h5>
        <div class="row g-2">
          <div class="col-md-4">
            <input id="ex_entity" class="form-control" placeholder="Loja/Empresa">
          </div>
          <div class="col-md-3">
            <select id="ex_cat" class="form-select">
              <option value="Mercado">Mercado</option>
              <option value="Moradia">Moradia/Aluguel</option>
              <option value="Serviços/Contas">Serviços/Contas</option>
              <option value="Transporte">Transporte</option>
              <option value="Lazer">Lazer</option>
              <option value="Outros">Outros</option>
            </select>
          </div>
          <div class="col-md-3">
            <input id="ex_val" class="form-control" placeholder="Valor (R$)" type="number" step="0.01">
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" id="ex_add"><i class="bi bi-plus-lg"></i></button>
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm table-striped">
            <thead><tr><th>Empresa</th><th>Categoria</th><th class="text-end">Valor</th><th></th></tr></thead>
            <tbody id="ex_body"></tbody>
            <tfoot><tr><th colspan="2">Total</th><th class="text-end" id="ex_total">R$ 0,00</th><th></th></tr></tfoot>
          </table>
        </div>
      </div></div>
    </div>
    <div class="col-12 col-lg-5">
      <div class="card shadow-sm"><div class="card-body">
        <h5 class="mb-3"><i class="bi bi-pie-chart me-2"></i>Gastos por categoria</h5>
        <canvas id="ex_chart" height="220"></canvas>
      </div></div>
      <div class="card shadow-sm mt-3"><div class="card-body">
        <h6 class="text-muted">Resumo da conta</h6>
        <div id="d_conta" class="small mb-1">Conta —</div>
        <div id="d_saldo" class="fw-bold">R$ 0,00</div>
      </div></div>
    </div>
  </div>
</script>

<script type="text/template" id="tpl-pagamentos">
  <div class="hero"><h5 class="mb-0">Pagamentos</h5><small class="text-muted">Pague estabelecimentos e transfira via PIX</small></div>

  <div class="alert alert-info d-flex justify-content-between align-items-center">
    <div><i class="bi bi-wallet2 me-2"></i>Adicionar saldo à conta</div>
    <div class="d-flex gap-2">
      <input id="dep_val" class="form-control form-control-sm" style="width:180px" placeholder="Valor (R$)" value="500.00" type="number" step="0.01">
      <button class="btn btn-sm btn-outline-primary" id="doDeposit"><i class="bi bi-plus-circle me-1"></i>Adicionar</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3"><i class="bi bi-arrow-left-right me-2"></i>Transferência PIX</h5>
          <div class="row g-2">
            <div class="col-12 col-lg-6">
              <label class="form-label">Chave Pix (CPF/CNPJ ou ID da Conta)</label>
              <input id="t_dest" class="form-control" placeholder="CPF ou ID da conta">
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label">Valor (R$)</label>
              <input id="t_val" class="form-control" value="100.00" type="number" step="0.01">
            </div>
          </div>
          <div class="d-grid mt-3">
            <button class="btn btn-primary" id="doTransfer">
              <i class="bi bi-send-fill me-1"></i>Transferir
            </button>
          </div>
          <div class="mt-3" id="t_msg"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3 justify-content-center">
    <div class="col-12"> 
      <div class="card shadow-sm border-0 bg-light">
          <div class="card-body p-3">
              <h6 class="text-muted mb-2"><i class="bi bi-info-circle me-1"></i> Dicas de Usabilidade e Fluxo</h6>
              <p class="small mb-1"><strong>Pagamento de Contas:</strong> Use o Dashboard para organizar suas contas (Luz, Água, Internet) na Planilha de Gastos e pagá-las com um clique no bloco **"Pagar Itens da Planilha"**.</p>
              <p class="small mb-0"><strong>Transferências PIX:</strong> Utilize o campo acima com o **CPF** ou o **ID da Conta** de outros usuários do POMENR para transferir valores instantaneamente.</p>
          </div>
      </div>
    </div>
  </div>
</script>

<script type="text/template" id="tpl-emprestimos">
  <div class="hero">
    <h5 class="mb-0">Empréstimos</h5>
    <small class="text-muted">Simule seu limite, solicite e pague as parcelas</small>
  </div>
  <div class="row">
    <div class="col-12 col-lg-10">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="mb-3"><i class="bi bi-calculator me-1"></i>Simulação e Solicitação</h5>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Valor desejado (R$)</label>
              <input id="e_val" class="form-control" value="10000.00" type="number" step="0.01" min="1">
            </div>
            <div class="col-md-4">
              <label class="form-label">Prazo (meses)</label>
              <input id="e_m" class="form-control" value="12" type="number" min="1" max="60">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-primary w-100" id="doLoan">
                <i class="bi bi-cash-stack me-1"></i> Solicitar
              </button>
            </div>
          </div>
          
          <div id="e_sim" class="mt-3 text-muted">
            Aguardando simulação...
          </div>

          <div class="mt-3" id="e_msg"></div>

          <hr>
          
          <h5 class="mt-2"><i class="bi bi-list-ol me-2"></i>Empréstimo atual</h5>
          <div id="e_current_actions" class="d-flex justify-content-between align-items-center mb-2">
            <div id="e_current" class="small text-muted">Carregando informações do empréstimo...</div>
            <button class="btn btn-sm btn-success hidden" id="doPayFull"><i class="bi bi-cash me-1"></i>Quitar Total</button>
          </div>

          <div class="table-responsive mt-2" id="e_table_wrap" style="display:none;">
            <table class="table table-sm table-striped align-middle">
              <thead>
                <tr>
                  <th>Parcela</th>
                  <th>Vencimento</th>
                  <th class="text-end">Valor (R$)</th>
                  <th class="text-center">Status</th>
                  <th class="text-end">Ações</th>
                </tr>
              </thead>
              <tbody id="e_parcels"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</script>

<script>
const API = "/api";
const app = document.getElementById('app');

const UTILITY_MAP = {
    'luz': { id: 11, desc: 'Conta de Luz' },
    'agua': { id: 12, desc: 'Conta de Água' },
    'internet': { id: 13, desc: 'Conta de Internet' }
};

function formatCurrency(cents) {
    return (cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
}

function toast(message, variant="primary") {
  const id = "t" + Math.random().toString(36).slice(2);
  const container = document.getElementById('toastContainer');
  const el = document.createElement('div');
  el.className = "toast align-items-center text-bg-" + variant + " border-0";
  el.id = id;
  el.role = "alert";
  el.ariaLive = "assertive";
  el.ariaAtomic = "true";
  el.innerHTML = `<div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>`;
  container.appendChild(el);
  const t = new bootstrap.Toast(el, { delay: 3500 });
  t.show();
  el.addEventListener('hidden.bs.toast', () => el.remove());
}

function customConfirm(title, message) {
    return new Promise(resolve => {
        const modalEl = document.getElementById('customConfirmModal');
        const modal = new bootstrap.Modal(modalEl);
        document.getElementById('customConfirmLabel').textContent = title;
        document.getElementById('customConfirmBody').textContent = message;

        const okBtn = document.getElementById('customConfirmOkBtn');
        const newOkBtn = okBtn.cloneNode(true);
        okBtn.parentNode.replaceChild(newOkBtn, okBtn);

        const confirmHandler = () => {
            modal.hide();
            resolve(true);
        };

        newOkBtn.addEventListener('click', confirmHandler, { once: true });
        
        modalEl.addEventListener('hidden.bs.modal', function handler() {
            resolve(false);
            modalEl.removeEventListener('hidden.bs.modal', handler);
        }, { once: true });

        modal.show();
    });
}

function setThemeToggle(){
  document.getElementById('themeBtn').onclick = () => {
    const html = document.documentElement;
    const cur = html.getAttribute('data-bs-theme') || 'light';
    const next = cur === 'light' ? 'dark' : 'light';
    html.setAttribute('data-bs-theme', next);
    document.getElementById('themeBtn').innerHTML =
      next === 'dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>';
  };
}
setThemeToggle();

function token(){ return localStorage.getItem('user_id'); }
function authHeaders(){ return token() ? {'X-User-Id': token()} : {}; }

async function post(path, body){
  const r = await fetch(API+path, {
    method:'POST',
    headers:{'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify(body)
  });
  const data = await r.json().catch(()=> ({}));
  if(!r.ok){
    if (r.status === 401) {
      localStorage.removeItem('user_id');
      toast('Sessão expirada ou não autenticado. Faça login novamente.', 'warning');
      location.hash = '#/login';
    }
    let msg = r.statusText;
    if (data && data.detail){
      if (Array.isArray(data.detail)) {
        msg = data.detail.map(d => d.msg || d.error || JSON.stringify(d)).join('; ');
      } else if (typeof data.detail === 'object') {
        msg = data.detail.msg || data.detail.error || JSON.stringify(data.detail);
      } else {
        msg = data.detail;
      }
    }
    throw new Error(msg);
  }
  return data;
}

async function get(path){
  const r = await fetch(API+path, {headers:{...authHeaders()}});
  const data = await r.json().catch(()=> ({}));
  if(!r.ok){
    if (r.status === 401) {
      localStorage.removeItem('user_id');
      toast('Sessão expirada ou não autenticado. Faça login novamente.', 'warning');
      location.hash = '#/login';
    }
    let msg = r.statusText;
    if (data && data.detail){
      if (Array.isArray(data.detail))
        msg = data.detail.map(d => d.msg || JSON.stringify(d)).join('; ');
      else if (typeof data.detail === 'object')
        msg = data.detail.msg || JSON.stringify(data.detail);
      else
        msg = data.detail;
    }
    throw new Error(msg);
  }
  return data;
}

function render(tplId){ app.innerHTML = document.getElementById(tplId).innerHTML; }

function requireAuth(){
  if(!token()){
    location.hash = '#/login';
    return false;
  }
  return true;
}

function setActiveLink(){
  const h = location.hash || '#/login';
  document.querySelectorAll('#menu .nav-link').forEach(a => {
    a.classList.toggle('active', h.startsWith(a.getAttribute('data-route')));
    a.classList.toggle('disabled', !token());
  });
  document.getElementById('btnLogout').onclick = () => {
    localStorage.removeItem('user_id');
    location.hash = '#/login';
  };
}

/* ---- DASHBOARD: gastos locais + resumo de conta ---- */
let exChart = null;
function loadExpenses(){
  try { return JSON.parse(localStorage.getItem('pomenr_expenses') || '[]'); }
  catch { return []; }
}
function saveExpenses(rows){ localStorage.setItem('pomenr_expenses', JSON.stringify(rows)); }
function renderExpenses(){
  const rows = loadExpenses();
  const body = document.getElementById('ex_body');
  const cur = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
  
  body.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${r.entity}</td>
      <td>${r.cat}</td>
      <td class="text-end">${cur.format(r.val)}</td>
      <td class="text-end"><button class="btn btn-sm btn-outline-danger" data-del="${i}"><i class="bi bi-trash"></i></button></td>
    </tr>`).join('');
  const total = rows.reduce((s,r)=>s + r.val, 0);
  document.getElementById('ex_total').innerText = cur.format(total);

  const byCat = {};
  rows.forEach(r => byCat[r.cat] = (byCat[r.cat]||0) + r.val);
  const labels = Object.keys(byCat);
  const data = Object.values(byCat);

  if(exChart){ exChart.destroy(); }
  const ctx = document.getElementById('ex_chart').getContext('2d');
  exChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ data }] } });
}

function renderDashboardBillPay(allExpenses) {
    const validBills = allExpenses
        .map((r, originalIndex) => ({ ...r, originalIndex }))
        .filter(r => r.entity && r.val > 0);
        
    const container = document.getElementById('db_bill_pay_content');
    
    if (validBills.length === 0) {
        container.innerHTML = '<div class="alert alert-info small mb-0">Nenhum item pendente na Planilha de Gastos.</div>';
        return;
    }

    const options = validBills.map((r, filteredIndex) => {
        const nameLower = r.entity.toLowerCase();
        let map = { id: 1, desc: r.cat }; 

        if (nameLower.includes('luz')) map = UTILITY_MAP['luz'];
        else if (nameLower.includes('água') || nameLower.includes('agua')) map = UTILITY_MAP['agua'];
        else if (nameLower.includes('internet')) map = UTILITY_MAP['internet'];

        return `<option value="${filteredIndex}" data-mid="${map.id}" data-desc="${map.desc} (${r.entity})" data-val="${r.val}" data-original-index="${r.originalIndex}">${r.entity} (${r.cat}) - ${formatCurrency(r.val * 100)}</option>`;
    });

    container.innerHTML = `
        <div class="row g-2 align-items-end">
            <div class="col-md-8">
                <label class="form-label">Item a Pagar na Planilha</label>
                <select id="db_bill_select" class="form-select">${options.join('')}</select>
            </div>
            <div class="col-md-4 d-grid">
                <button class="btn btn-danger" id="doDbBillPay_action">
                    <i class="bi bi-cash me-1"></i> Pagar Item
                </button>
            </div>
        </div>
    `;

    document.getElementById('doDbBillPay_action').onclick = async () => {
        const select = document.getElementById('db_bill_select');
        const selectedOption = select.options[select.selectedIndex];

        const originalIndex = parseInt(selectedOption.dataset.originalIndex); 
        const mid = parseInt(selectedOption.dataset.mid);
        const desc = selectedOption.dataset.desc;
        const valor_reais = parseFloat(selectedOption.dataset.val);
        const valor_cents = Math.round(valor_reais * 100); 
        const msgEl = document.getElementById('db_bill_msg');

        if (!mid || !valor_cents) {
            toast('Erro: Dados da conta ausentes ou inválidos.', 'danger');
            return;
        }

        if (await customConfirm('Confirmar Pagamento', `Deseja pagar ${desc} no valor de ${formatCurrency(valor_cents)}? O item será removido da planilha local.`)) {
            try {
                const body = {
                    id_conta_de: 0, 
                    id_comerciante: mid,
                    valor_cents: valor_cents
                };
                
                const path = (mid >= 11 && mid <= 13) ? '/payments/utility' : '/payments';
                const res = await post(path, body);
                
                const currentRows = loadExpenses();
                currentRows.splice(originalIndex, 1);
                saveExpenses(currentRows);

                toast('Pagamento realizado com sucesso!', 'success');
                msgEl.className = 'text-success';
                msgEl.innerText = `${desc} paga. Transação ${res.id_transacao}.`;

                showDashboard(); 

            } catch (e) {
                msgEl.className = 'text-danger';
                msgEl.innerText = 'Erro: ' + e.message;
            }
        }
    };
}

async function showDashboard(){
  if(!requireAuth()) return;
  render('tpl-dashboard');

  try{
    const sum = await get('/me/summary/'+token());
    if(sum && sum.numero_conta){
      document.getElementById('d_saldo').innerText = formatCurrency(sum.saldo_cents);
      document.getElementById('d_conta').innerText =
        `Conta ${sum.numero_conta} • Agência ${sum.agencia}`;
      
    // REMOVIDO: Bloco de ID PJ
    }
  }catch(e){ /* silencioso */ }

  const allExpenses = loadExpenses();
  renderDashboardBillPay(allExpenses); 
  renderExpenses();

  document.getElementById('ex_add').onclick = () => {
    const entity = document.getElementById('ex_entity').value.trim();
    const cat  = document.getElementById('ex_cat').value;
    const val  = parseFloat(document.getElementById('ex_val').value || '0');
    
    if(!entity || !val){
      toast('Preencha a Loja/Empresa e o valor.', 'warning');
      return;
    }
    const rows = loadExpenses();
    rows.push({entity, cat, val});
    saveExpenses(rows);
    
    document.getElementById('ex_entity').value = '';
    document.getElementById('ex_val').value  = '';
    showDashboard();
  };
  document.getElementById('ex_body').addEventListener('click', e => {
    const i = e.target.closest('[data-del]')?.getAttribute('data-del');
    if(i !== null && i !== undefined){
      const rows = loadExpenses();
      rows.splice(Number(i),1);
      saveExpenses(rows);
      showDashboard();
    }
  });
}

/* ---- PÁGINAS (Restante) ---- */
function showLogin(){
  render('tpl-login');
  document.getElementById('doLogin').onclick = async () => {
    try{
      const cpf = document.getElementById('login_cpf').value.trim();
      const senha = document.getElementById('login_senha').value;
      const res = await post('/auth/login', {doc_cpf_cnpj: cpf, senha});
      localStorage.setItem('user_id', res.id_usuario);
      toast('Bem-vindo! Login realizado.', 'success');
      location.hash = '#/dashboard';
    }catch(e){
      toast('Falha no login: ' + e.message, 'danger');
    }
  };
}

function showRegister(){
  render('tpl-register');
  document.getElementById('doRegister').onclick = async () => {
    try{
      const salario_reais = parseFloat(document.getElementById('r_sal').value || '0');
      const body = {
        nome: document.getElementById('r_nome').value,
        doc_cpf_cnpj: document.getElementById('r_cpf').value,
        email: document.getElementById('r_email').value,
        telefone: document.getElementById('r_tel').value,
        senha: document.getElementById('r_senha').value,
        salario_mensal_cents: Math.round(salario_reais * 100),
        tipo_pessoa: document.getElementById('r_tipo').value 
      };
      const res = await post('/auth/register', body);
      localStorage.setItem('user_id', res.id_usuario);
      toast('Cadastro concluído!', 'success');
      location.hash = '#/dashboard';
    }catch(e){
      toast('Falha ao registrar: ' + e.message, 'danger');
    }
  };
}

function showPagamentos(){
  if(!requireAuth()) return;
  render('tpl-pagamentos');

  document.getElementById('doDeposit').onclick = async () => {
    try{
      const v_reais = parseFloat(document.getElementById('dep_val').value || '0');
      const v = Math.round(v_reais * 100);
      if(!v || v <= 0){
        toast('Informe um valor válido (em R$).', 'warning');
        return;
      }
      await post('/accounts/deposit', { valor_cents: v, referencia: 'DEP-UI' });
      toast('Depósito realizado com sucesso!', 'success');
    }catch(e){
      toast('Falha no depósito: ' + e.message, 'danger');
    }
  };

  document.getElementById('doTransfer').onclick = async () => {
    try{
      const dest = document.getElementById('t_dest').value.trim(); 
      const valor_reais = parseFloat(document.getElementById('t_val').value || '0');
      const valor = Math.round(valor_reais * 100);
      if(!dest || !valor){
        toast('Preencha o destino e o valor.', 'warning');
        return;
      }
      const body = { identificador: dest, valor_cents: valor };
      
      if(await customConfirm('Confirmar PIX', `Deseja transferir ${formatCurrency(valor)} para o destino ${dest}?`)) {
        const res = await post('/transfers', body);
        const m = document.getElementById('t_msg');
        m.className = 'text-success';
        m.innerHTML = `Transferência de ${formatCurrency(res.valor_cents)} enviada para <b>${res.nome_destino}</b>. Transação ${res.id_transacao}.`;
      }
    }catch(e){
      const m = document.getElementById('t_msg');
      m.className = 'text-danger';
      m.innerText = 'Erro: '+e.message;
    }
  };
}

function showEmprestimos(){
  if(!requireAuth()) return;
  render('tpl-emprestimos');

  async function simulateLoanDetail(){
    const val_reais = parseFloat(document.getElementById('e_val').value || '0');
    const meses = parseInt(document.getElementById('e_m').value || '0');
    const info = document.getElementById('e_sim');
    const solicitarBtn = document.getElementById('doLoan');
    info.className = 'mt-3 text-muted';
    solicitarBtn.disabled = true;

    if (isNaN(val_reais) || val_reais <= 0 || isNaN(meses) || meses <= 0) {
        info.innerHTML = 'Informe o valor desejado (R$) e o prazo (meses) para simular.';
        return;
    }

    try{
        const body = {
            principal_cents: Math.round(val_reais * 100),
            prazo_meses: meses
        };
        const sim = await post('/loans/simulate', body);
        
        const cur = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});
        const pmt_val = cur.format(sim.pmt_cents / 100);
        const max_val = cur.format(sim.principal_max_cents / 100);
        
        let msg = `
            <strong>Juros a.a.:</strong> ${sim.juros_aa_pct.toFixed(2)}% (${sim.juros_mensal_pct.toFixed(3)}% a.m.)<br>
            <strong>Parcela Mensal Estimada:</strong> <span class="fw-bold text-success">${pmt_val}</span><br>
            <strong>Limite Máximo (30% Renda):</strong> ${max_val}
        `;
        
        solicitarBtn.disabled = false;
        
        if (sim.principal_max_cents < body.principal_cents) {
            msg += `<br><span class="text-danger fw-bold">VALOR REJEITADO: O valor solicitado excede o limite permitido pela renda.</span>`;
            solicitarBtn.disabled = true;
        }

        info.innerHTML = msg;
        
    }catch(e){
        info.innerHTML = 'Erro na simulação: '+e.message;
        info.className = 'mt-3 text-danger';
        solicitarBtn.disabled = true;
    }
  }

  document.getElementById('e_val').addEventListener('input', simulateLoanDetail);
  document.getElementById('e_m').addEventListener('input', simulateLoanDetail);
  
  simulateLoanDetail();

  document.getElementById('doLoan').onclick = async () => {
    const val_reais = parseFloat(document.getElementById('e_val').value || '0');
    const meses = parseInt(document.getElementById('e_m').value || '0');
    const e_msg = document.getElementById('e_msg');
    e_msg.className = 'mt-3 text-muted';
    e_msg.innerText = 'Processando solicitação...';
    
    if (document.getElementById('doLoan').disabled) {
        e_msg.className = 'mt-3 text-danger';
        e_msg.innerText = 'Não é possível solicitar. Verifique o valor/limite na simulação.';
        return;
    }

    try{
        const sim = await post('/loans/simulate', {
            principal_cents: Math.round(val_reais * 100),
            prazo_meses: meses
        });
        
        const body = {
            id_conta: 0,
            principal_cents: Math.round(val_reais * 100),
            juros_aa_pct: sim.juros_aa_pct, 
            prazo_meses: meses
        };
        
        if (body.principal_cents > sim.principal_max_cents) {
             throw new Error("Valor excede o limite máximo. Ajuste e tente novamente.");
        }

        const res = await post('/loans/create', body);
        e_msg.className = 'text-success';
        e_msg.innerText = `Empréstimo criado com sucesso! ID ${res.id_emprestimo}. Parcela: ${formatCurrency(sim.pmt_cents)}.`;
        loadCurrentLoan(); 
    }catch(e){
        e_msg.className = 'text-danger';
        e_msg.innerText = 'Erro: '+e.message;
    }
  };

  document.getElementById('doPayFull').onclick = async (ev) => {
    const btn = ev.target.closest('button');
    const id_emprestimo = parseInt(btn.dataset.loanId);
    if(!id_emprestimo) return;

    if (await customConfirm('Confirmação de Quitação', 'Tem certeza que deseja quitar o empréstimo inteiro? O valor total restante será debitado da sua conta.')) {
        try {
            await post('/loans/pay_full', { id_emprestimo, id_conta: 0 });
            toast('Empréstimo quitado com sucesso! Recarregando tela...', 'success');
            loadCurrentLoan();
        } catch (e) {
            toast('Erro ao quitar empréstimo: ' + e.message, 'danger');
        }
    }
  };

  async function loadCurrentLoan(){
    const info = document.getElementById('e_current');
    const wrap = document.getElementById('e_table_wrap');
    const tbody = document.getElementById('e_parcels');
    const payFullBtn = document.getElementById('doPayFull');

    info.textContent = 'Carregando informações do empréstimo...';
    wrap.style.display = 'none';
    tbody.innerHTML = '';
    payFullBtn.classList.add('hidden'); 

    try{
      const loan = await get('/loans/current');
      if(!loan || !loan.id_emprestimo){
        info.textContent = 'Nenhum empréstimo ativo no momento.';
        return;
      }
      const total = loan.principal_cents || 0;
      const status = loan.status || '—';
      
      info.textContent =
        `Empréstimo #${loan.id_emprestimo} • Status: ${status} • ` +
        `Valor contratado: ${formatCurrency(total)}`;
      
      if (status !== 'paid' && status !== 'cancelled') {
        payFullBtn.classList.remove('hidden');
        payFullBtn.dataset.loanId = loan.id_emprestimo;
      }

      const rows = await get(`/loans/${loan.id_emprestimo}/installments`);
      if(!rows || rows.length === 0){
        info.textContent += ' • Nenhuma parcela encontrada.';
        return;
      }
      tbody.innerHTML = rows.map(r => {
        const pago = r.pago;
        const badge = pago
          ? '<span class="badge bg-success">Pago</span>'
          : '<span class="badge bg-warning text-dark">Em aberto</span>';
        const btn = pago
          ? ''
          : `<button class="btn btn-sm btn-outline-primary" data-pay="${r.id_parcela}">
               <i class="bi bi-credit-card"></i> Pagar
             </button>`;
        const venc = r.vencimento ? new Date(r.vencimento).toLocaleDateString('pt-BR') : '—';
        return `
          <tr>
            <td>${r.num_parcela}</td>
            <td>${venc}</td>
            <td class="text-end">${formatCurrency(r.valor_cents)}</td>
            <td class="text-center">${badge}</td>
            <td class="text-end">${btn}</td>
          </tr>`;
      }).join('');
      wrap.style.display = '';
    }catch(e){
      info.textContent = 'Erro ao carregar empréstimo: ' + e.message;
    }
  }

  document.addEventListener('click', async (ev) => {
    const btn = ev.target.closest('[data-pay]');
    if(!btn) return;
    const idParcela = parseInt(btn.getAttribute('data-pay'));
    if(!idParcela) return;
    
    if(await customConfirm('Confirmação de Pagamento', 'Confirma o pagamento desta parcela? O valor será debitado da sua conta.')) {
        try{
            await post('/installments/pay', { id_parcela: idParcela, id_conta: 0 });
            toast('Parcela paga com sucesso!', 'success');
            loadCurrentLoan();
        }catch(e){
            toast('Erro ao pagar parcela: ' + e.message, 'danger');
        }
    }
  }, { once:false });

  loadCurrentLoan();
}

function showRelatorios(){
  if(!requireAuth()) return;
  render('tpl-relatorios');
  document.getElementById('doReport').onclick = async () => {
    try{
      const rows = await get('/reports/faturamento-mensal');
      const body = document.getElementById('r_body');
      body.innerHTML = rows.map(r =>
        `<tr><td>${r.nome_fantasia}</td><td>${r.mes}</td><td>${r.qtde}</td><td>${formatCurrency(r.total_cents)}</td></tr>`
      ).join('');
      document.getElementById('r_table').classList.remove('hidden');
    }catch(e){
      toast('Erro ao carregar relatório: ' + e.message, 'danger');
    }
  };
}

function router(){
  setActiveLink();
  const h = location.hash || '#/login';
  if(h.startsWith('#/dashboard'))   return showDashboard();
  if(h.startsWith('#/pagamentos'))  return showPagamentos();
  if(h.startsWith('#/emprestimos')) return showEmprestimos();
  if(h.startsWith('#/relatorios'))  return showRelatorios();
  if(h.startsWith('#/registrar'))   return showRegister();
  return showLogin();
}
window.addEventListener('hashchange', router);
router();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>